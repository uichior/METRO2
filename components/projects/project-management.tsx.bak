"use client"

import { useState, useMemo } from "react"
import { ManagementPageTemplate } from "../templates/management-page-template"
import { ProjectListItem } from "./project-list-item"
import { ProjectDetail } from "./project-detail"
import { ProjectNavigation } from "./project-navigation"
import { Project } from "./types"

// サンプルプロジェクトデータ
const sampleProjects: Project[] = [
  {
    id: "1",
    code: "PRJ-2025-001",
    name: "新工場設備導入プロジェクト",
    description: "東京工場における新規製造ラインの設計、導入、および稼働までの一連のプロジェクト。生産効率を30%向上させることが目標。",
    client: "株式会社メトロ製造",
    status: "進行中",
    startDate: "2025-01-15",
    endDate: "2025-07-30",
    budget: 25000000,
    cost: 12500000,
    manager: "山田太郎",
    team: ["佐藤一郎", "鈴木花子", "田中健太", "伊藤美咲"],
    totalTasks: 48,
    completedTasks: 22,
    milestones: [
      {
        id: "m1",
        name: "要件定義完了",
        dueDate: "2025-02-15",
        status: "完了",
        description: "製造ライン要件の最終確定"
      },
      {
        id: "m2",
        name: "設計フェーズ完了",
        dueDate: "2025-03-30",
        status: "完了",
        description: "製造ライン設計書の承認"
      },
      {
        id: "m3",
        name: "機器導入完了",
        dueDate: "2025-05-15",
        status: "進行中",
        description: "全ての機器の設置と初期設定"
      },
      {
        id: "m4",
        name: "テスト完了",
        dueDate: "2025-06-30",
        status: "未着手",
        description: "品質テストと性能評価"
      },
      {
        id: "m5",
        name: "本番稼働開始",
        dueDate: "2025-07-30",
        status: "未着手",
        description: "新製造ラインの正式稼働"
      }
    ],
    attachments: [
      {
        id: "a1",
        name: "要件定義書.pdf",
        type: "PDF",
        size: 2048,
        uploadDate: "2025-01-20",
        uploadedBy: "山田太郎",
        url: "#"
      },
      {
        id: "a2",
        name: "設計図面.dwg",
        type: "CAD",
        size: 4096,
        uploadDate: "2025-03-05",
        uploadedBy: "佐藤一郎",
        url: "#"
      },
      {
        id: "a3",
        name: "進捗報告書_Q1.xlsx",
        type: "Excel",
        size: 1536,
        uploadDate: "2025-04-01",
        uploadedBy: "山田太郎",
        url: "#"
      }
    ]
  },
  {
    id: "2",
    code: "PRJ-2025-002",
    name: "販売管理システム刷新",
    description: "既存の販売管理システムを最新のクラウドベースシステムに移行するプロジェクト。営業部門の業務効率化と顧客管理の強化が目的。",
    client: "メトロ営業部",
    status: "計画中",
    startDate: "2025-05-01",
    endDate: "2025-11-30",
    budget: 18000000,
    cost: 2000000,
    manager: "鈴木次郎",
    team: ["高橋裕子", "渡辺健", "中村真理"],
    totalTasks: 36,
    completedTasks: 4,
    milestones: [
      {
        id: "m1",
        name: "要件定義",
        dueDate: "2025-06-15",
        status: "進行中",
        description: "新システムの要件定義と現行システムの分析"
      },
      {
        id: "m2",
        name: "ベンダー選定",
        dueDate: "2025-07-30",
        status: "未着手",
        description: "システム提供ベンダーの選定と契約"
      },
      {
        id: "m3",
        name: "データ移行計画",
        dueDate: "2025-08-30",
        status: "未着手",
        description: "現行システムからのデータ移行計画策定"
      },
      {
        id: "m4",
        name: "システム導入",
        dueDate: "2025-10-15",
        status: "未着手",
        description: "新システムの導入とテスト"
      },
      {
        id: "m5",
        name: "本番稼働",
        dueDate: "2025-11-30",
        status: "未着手",
        description: "新システムの本番稼働開始"
      }
    ],
    attachments: [
      {
        id: "a1",
        name: "現行システム分析.docx",
        type: "Word",
        size: 1024,
        uploadDate: "2025-04-15",
        uploadedBy: "鈴木次郎",
        url: "#"
      },
      {
        id: "a2",
        name: "要件定義書_ドラフト.pdf",
        type: "PDF",
        size: 1536,
        uploadDate: "2025-05-10",
        uploadedBy: "高橋裕子",
        url: "#"
      }
    ]
  },
  {
    id: "3",
    code: "PRJ-2025-003",
    name: "海外展示会出展プロジェクト",
    description: "ドイツで開催される国際製造業展示会への出展プロジェクト。新製品のプロモーションと海外顧客開拓が目的。",
    client: "メトロ国際営業部",
    status: "完了",
    startDate: "2025-01-10",
    endDate: "2025-03-20",
    budget: 8000000,
    cost: 7500000,
    manager: "佐々木美香",
    team: ["小林健太", "加藤洋子"],
    totalTasks: 24,
    completedTasks: 24,
    milestones: [
      {
        id: "m1",
        name: "出展申込",
        dueDate: "2025-01-15",
        status: "完了",
        description: "展示会への出展申込と小間の確保"
      },
      {
        id: "m2",
        name: "展示物準備",
        dueDate: "2025-02-10",
        status: "完了",
        description: "展示製品と販促物の準備"
      },
      {
        id: "m3",
        name: "出展",
        dueDate: "2025-03-15",
        status: "完了",
        description: "展示会への出展と運営"
      },
      {
        id: "m4",
        name: "フォローアップ",
        dueDate: "2025-03-20",
        status: "完了",
        description: "展示会で得た顧客リードへのフォローアップ"
      }
    ],
    attachments: [
      {
        id: "a1",
        name: "展示会申込書.pdf",
        type: "PDF",
        size: 512,
        uploadDate: "2025-01-12",
        uploadedBy: "佐々木美香",
        url: "#"
      },
      {
        id: "a2",
        name: "展示ブース設計図.jpg",
        type: "Image",
        size: 2048,
        uploadDate: "2025-01-25",
        uploadedBy: "小林健太",
        url: "#"
      },
      {
        id: "a3",
        name: "来場者リスト.xlsx",
        type: "Excel",
        size: 1024,
        uploadDate: "2025-03-18",
        uploadedBy: "加藤洋子",
        url: "#"
      },
      {
        id: "a4",
        name: "展示会報告書.pdf",
        type: "PDF",
        size: 3072,
        uploadDate: "2025-03-25",
        uploadedBy: "佐々木美香",
        url: "#"
      }
    ]
  },
  {
    id: "4",
    code: "PRJ-2025-004",
    name: "品質管理プロセス改善",
    description: "製造工程における品質管理プロセスの見直しと改善プロジェクト。不良品率の低減と検査工程の効率化が目標。",
    client: "メトロ品質管理部",
    status: "中断",
    startDate: "2025-02-01",
    endDate: "2025-06-30",
    budget: 12000000,
    cost: 4000000,
    manager: "木村正人",
    team: ["松本さやか", "井上拓也", "山本健一"],
    totalTasks: 30,
    completedTasks: 10,
    milestones: [
      {
        id: "m1",
        name: "現状分析",
        dueDate: "2025-02-28",
        status: "完了",
        description: "現行の品質管理プロセスの分析と課題抽出"
      },
      {
        id: "m2",
        name: "改善計画策定",
        dueDate: "2025-03-31",
        status: "完了",
        description: "品質管理プロセス改善計画の策定"
      },
      {
        id: "m3",
        name: "パイロット実施",
        dueDate: "2025-04-30",
        status: "中断",
        description: "一部製造ラインでの改善プロセスのパイロット実施"
      },
      {
        id: "m4",
        name: "全面展開",
        dueDate: "2025-06-15",
        status: "未着手",
        description: "全製造ラインへの改善プロセスの展開"
      }
    ],
    attachments: [
      {
        id: "a1",
        name: "品質管理現状分析.pdf",
        type: "PDF",
        size: 2048,
        uploadDate: "2025-02-25",
        uploadedBy: "木村正人",
        url: "#"
      },
      {
        id: "a2",
        name: "改善計画書.docx",
        type: "Word",
        size: 1536,
        uploadDate: "2025-03-28",
        uploadedBy: "松本さやか",
        url: "#"
      },
      {
        id: "a3",
        name: "中断報告書.pdf",
        type: "PDF",
        size: 1024,
        uploadDate: "2025-05-02",
        uploadedBy: "木村正人",
        url: "#"
      }
    ]
  }
]

// フィルター設定
const filterConfigs = [
  {
    id: "status",
    label: "ステータス",
    options: [
      { value: "", label: "すべて" },
      { value: "計画中", label: "計画中" },
      { value: "進行中", label: "進行中" },
      { value: "完了", label: "完了" },
      { value: "中断", label: "中断" }
    ]
  }
]

export function ProjectManagement() {
  // フィルターの状態管理
  const [activeFilters, setActiveFilters] = useState<Record<string, string>>({
    status: 'すべて',
    assignee: 'すべて',
    timeframe: 'すべて'
  })

  // 新規作成ハンドラー
  const handleAddNew = () => {
    console.log("新規プロジェクト作成ボタンがクリックされました")

  // プロジェクト数のカウント
  const projectCounts = useMemo(() => {
    return {
      total: sampleProjects.length,
      planning: sampleProjects.filter(p => p.status === '計画中').length,
      inProgress: sampleProjects.filter(p => p.status === '進行中').length,
      completed: sampleProjects.filter(p => p.status === '完了').length,
      onHold: sampleProjects.filter(p => p.status === '中断').length
    }
  }, [sampleProjects])

  // ナビゲーションパネルからのフィルター変更ハンドラー
  const handleNavigationFilterChange = ({ type, value }: { type: string; value: string }) => {
    setActiveFilters(prev => ({
      ...prev,
      [type]: value
    }))
  }

  // ナビゲーションパネル
  const navigationPanel = (
    <ProjectNavigation 
      onFilterChange={handleNavigationFilterChange}
      activeFilters={activeFilters}
      projectCounts={projectCounts}
    />
  )

  // フィルタリング関数
  const getFilteredProjects = (projects: Project[], searchTerm: string, filters: Record<string, string>) => {
    return projects.filter(project => {
      // 検索語句によるフィルタリング
      if (searchTerm && !project.name.toLowerCase().includes(searchTerm.toLowerCase()) && 
          !project.code.toLowerCase().includes(searchTerm.toLowerCase()) &&
          !project.client.toLowerCase().includes(searchTerm.toLowerCase())) {
        return false
      }

      // ステータスによるフィルタリング（ナビゲーションパネルとリストパネルの両方から）
      if (activeFilters.status !== 'すべて' && project.status !== activeFilters.status) {
        return false
      }
      if (filters.status && filters.status !== 'すべて' && project.status !== filters.status) {
        return false
      }

      // 担当者によるフィルタリング
      if (activeFilters.assignee === '自分' && project.manager !== '山田太郎') { // 仮の現在のユーザー
        return false
      }

      // 期間によるフィルタリング
      if (activeFilters.timeframe !== 'すべて') {
        const now = new Date()
        const startDate = new Date(project.startDate)
        const endDate = new Date(project.endDate)
        
        if (activeFilters.timeframe === '今月') {
          const isThisMonth = startDate.getMonth() === now.getMonth() && startDate.getFullYear() === now.getFullYear() ||
                             endDate.getMonth() === now.getMonth() && endDate.getFullYear() === now.getFullYear()
          if (!isThisMonth) return false
        } else if (activeFilters.timeframe === '今四半期') {
          const currentQuarter = Math.floor(now.getMonth() / 3)
          const startQuarter = Math.floor(startDate.getMonth() / 3)
          const endQuarter = Math.floor(endDate.getMonth() / 3)
          
          const isThisQuarter = (startQuarter === currentQuarter && startDate.getFullYear() === now.getFullYear()) ||
                               (endQuarter === currentQuarter && endDate.getFullYear() === now.getFullYear())
          if (!isThisQuarter) return false
        } else if (activeFilters.timeframe === '今年') {
          const isThisYear = startDate.getFullYear() === now.getFullYear() ||
                            endDate.getFullYear() === now.getFullYear()
          if (!isThisYear) return false
        }
      }

      // 予算によるフィルタリング
      if (filters.budget) {
        const budget = parseInt(project.budget.toString())
        if (filters.budget === '1000万円未満' && budget >= 10000000) return false
        if (filters.budget === '1000万円以上3000万円未満' && (budget < 10000000 || budget >= 30000000)) return false
        if (filters.budget === '3000万円以上' && budget < 30000000) return false
      }

      return true
    })
  }

  return (
    <ManagementPageTemplate
      title="プロジェクト管理"
      itemName="プロジェクト"
      items={sampleProjects}
      getFilteredItems={getFilteredProjects}
      navigationPanel={navigationPanel}
      listItemComponent={({ item, isSelected, onSelect }) => (
        <ProjectListItem 
          project={item} 
          isSelected={isSelected} 
          onSelect={onSelect}
        />
      )}
      detailComponent={({ selectedItem }) => (
        <ProjectDetail selectedProject={selectedItem} />
      )}
      filterConfigs={filterConfigs}
      onAddNew={() => alert('新規プロジェクト作成')}
      onExport={() => alert('プロジェクトデータのエクスポート')}
    />
  )
}

